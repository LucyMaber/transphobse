import re
import unicodedata


KEYWORDS = [
    "transphobia",
    "transphobic",
    "anti-trans",
    "trans hate",
    "trans exclusion",
    "trans rights violation",
    "trans discrimination",
    "trans ",
    "trans-",
    "transgender",
    "trans people",
    "trans community",
    "gender-",
    "trans issues",
    "trans rights",
    "non binary",
    "non-binary",
    "gender non-conforming",
    "gender identity",
    "trans advocacy",
    "trans-inclusive",
    "misgendering",
    "deadnaming",
    "gender-critical feminism",
    "trans-exclusionary radical feminist",
    "terf ",
    "trans exclusionary feminism",
    "gender critical",
    "adult human female",
    "trans identified males",
    "Transology",
    "misgendered",
    "gender-critical",
    "trans breast milk",
    "Hormone blockers",
    "puberty blockers",
    "tranvestia",
    "transmedicalism",
    "gender ",
    "trans man",
    "trans woman",
    "trans.",
    "trans?",
    "trans,",
    "trans",
    "Cass Review",
    "hilary cass",
    "cass report",
    "hilary-cass",
    "cass-report",
    "wrong body",
    "transsexual",
    "biological woman",
    "biological male",
    "biological man",
    "biological female",
    "gender-neutral",
    "demimasc",
    "demigirl",
    "demiboy",
    "demifluid",
    "demiflux",
    "demigender",
    "demiguy",
    "demigal",
    "demienby",
    "gender-based",
    "gender agnostic",
    "intersex woman",
    "intersex man",
    "intersex person",
    "intersex people",
    "intersex",
    "vakasalewalewa",
    "genderfluid",
    "gender queer",
    "gender-queer",
    "genderqueer",
    "genderqueer person",
    "genderqueer people",
    "fakafifine",
    "androgyne",
    "androgynous",
    "androgynous person",
    "androgynous people",
    "bigender",
    "bigender person",
    "cisgender",
    "x-gender",
    "cogenitor",
    "altersex",
    "assigned female at birth",
    "neutral sex",
    "assigned at birth",
    "transmasculine",
    "genderfluid",
    "travesti",
    "hermaphroditism",
    "cisgender man",
    "cisgender woman",
    "genderqueer",
    "takatāpui",
    "androgynos",
    "'akava'ine",
    "māhū",
    "muxe",
    "faʻafafine",
    "shapeshifter",
    "futanari",
    "fakaleitī",
    "agender",
    "hijra",
    "kathoey",
    "two spirit",
    "androgyny",
    # "queer",
    "third gender",
    "third-gender",
    "non-binary",
    "trannies",
    "tranny",
    "women-only",
    "women only",
    "lgb",
    "sex matters",
    "single sex spaces",
    "gender identity",
    "misgendering",
    "transphobi",
    "intersectionality",
    "conversion therapy",
    "biological essentialism",
    "identity denial",
    "gender dysphoria",
    "gender euphoria",
    "protect women's rights",
    "protect women rights",
    "protect womens rights",
    "sex change",
    "sex-change",
    "transgender",
    "social contagion",
    "detransition",
    "rapid onset gender dysphoria",
    "female erasure",
    "sex-based rights",
    "sex based rights",
    "men in women's spaces",
    "protect women's sports",
    "men in women spaces",
    "protect women sports",
    "men in womens spaces",
    "protect womens sports",
    "female erasure",
    "female erasure",
    "detransitioners",
    "detransition",
    "affirming care",
    "trans youth",
    "gender clinic",
    "gender specialist",
    "intersectional feminism",
    "intersectional",
    "queer liberation",
    "trans-inclusive feminism",
    "trans inclusive feminism",
    "LGBTQIA",
    "Sex-based rights",
    "Sex based rights",
    "Sex rights",
    "gender divisions",
    "racial and gender equality",
    "anti-male",
    "anti male",
    "anti-woman",
    "anti-female",
    "anti female",
    "legal definition of sex",
]

OGS_KEYWORDS = []

irrelevant_for_keywords = [
    "transcended",
    "transfer",
    "transport",
    "transportation",
    "transporting",
    "transition",
    "transfusion",
    "transpennine",
    "transam",
    "transformative",
    "transplant",
    "sustrans",
    "transient",
    "transferred",
    "transit",
    "transatlantic",
    "trans atlantic",
    "trans-atlantic",
    "trans-pacific",
    "trans pacific",
    "gender and ethnicity",
    "gender reveal parties",
    "gender price gap",
    "gender pay gap",
    "turtles' gender",
    "gender performance",
    "gendered marketing",
    "gender roles",
    "gender equity",
    "gender wage",
    "gendered language",
    "gender equity",
    "turtle gender",
    "transformers",
    "transformers",
    "transporters",
    "transition metals",
    "transitioning states",
    "trans logistics",
    "trans peak",
    "transitional government",
    "transistor",
    "transnational",
    "transpiration",
    "transistor radio",
    "transitory",
    "transversely",
    "transylvanian",
    "transparent",
    "transfusion reaction",
    "gender reassignment",
    "transdermal",
    "transformers prime",
    "transformers movie",
    "transmogrify",
    "transmutation",
    "transubstantiation",
    "transformerless",
    "transmissible",
    "transcriber",
    "transference",
    "transponder",
    "transcontinental",
    "translocator",
    "transgenic",
    "transition metals",
    "transmute",
    "transcriber",
    "transcoding",
    "transcription",
    "transcendental",
    "transformation",
    "transistor",
    "transmitter",
    "translation",
    "transdermal",
    "transfiguration",
    "transgenic",
    "transit",
    "translucent",
    "transmutation",
    "transnational",
    "transparent",
    "transcontinental",
    "transfection",
    "transfinite",
    "transpolar",
    "transom",
    "transpire",
    "transmission",
    "transe",
    "transa",
    "atrans",
    "itrans",
    "strans",
    "ctrans",
    "transf",
    "transl",
    "transm",
    "transp",
    "transv",
    "transx",
    "vtrans",
    "transit",
    "transom",
    "intrans",
    "transia",
    "transil",
    "transys",
    "transwa",
    "transsc",
    "transyt",
    "wytrans",
    "transmo",
    "eutrans",
    "cotrans",
    "sptrans",
    "patrans",
    "transex",
    "transec",
    "transac",
    "transas",
    "transax",
    "transch",
    "transco",
    "butrans",
    "transly",
    "transin",
    "transfer",
    "transmit",
    "transact",
    "transept",
    "transect",
    "transfix",
    "tranship",
    "transude",
    "transits",
    "transoms",
    "dextrans",
    "transire",
    "transkei",
    "transnet",
    "transman",
    "transmew",
    "transcur",
    "transume",
    "transyte",
    "unitrans",
    "westrans",
    "transron",
    "transtar",
    "transdev",
    "transdiv",
    "transadf",
    "transair",
    "transarc",
    "transbus",
    "eastrans",
    "avitrans",
    "nestrans",
    "sistrans",
    "sustrans",
    "samtrans",
    "transmat",
    "transpac",
    "transmux",
    "transims",
    "transmac",
    "translit",
    "transltr",
    "transhab",
    "transgas",
    "transgaz",
    "transifs",
    "transloc",
    "transord",
    "transnow",
    "transocm",
    "transmod",
    "transpec",
    "transpor",
    "sectrans",
    "saftrans",
    "reftrans",
    "reptrans",
    "navtrans",
    "jictrans",
    "caltrans",
    "diptrans",
    "filtrans",
    "geotrans",
    "transcad",
    "transcap",
    "tktransr",
    "transdec",
    "transcom",
    "transeat",
    "transsec",
    "transval",
    "transtec",
    "transport",
    "transform",
    "translate",
    "transient",
    "transcend",
    "transpire",
    "transgene",
    "transpose",
    "transmute",
    "transfuse",
    "transonic",
    "transaxle",
    "transduce",
    "transship",
    "transeunt",
    "transfect",
    "transects",
    "transepts",
    "transfers",
    "transacts",
    "transmits",
    "tranships",
    "transited",
    "transuded",
    "transudes",
    "transumpt",
    "transvaal",
    "transvert",
    "transhape",
    "transflux",
    "transfuge",
    "transfund",
    "transmove",
    "transpare",
    "transpass",
    "transenne",
    "transcode",
    "transenna",
    "transcyte",
    "transcona",
    "transmeta",
    "transitus",
    "transitio",
    "transvest",
    "transsect",
    "transtrum",
    "transtech",
    "transterm",
    "transwave",
    "transwerk",
    "wordtrans",
    "transjoik",
    "translink",
    "translohr",
    "transhelp",
    "transgrid",
    "transfare",
    "transecur",
    "transcare",
    "transapex",
    "transaero",
    "transalta",
    "helitrans",
    "duratrans",
    "itransact",
    "mototrans",
    "omnitrans",
    "sinotrans",
    "pinftrans",
    "capstrans",
    "actransit",
    "cinctrans",
    "cttransit",
    "transcaer",
    "transcomm",
    "transcoop",
    "transitex",
    "transmete",
    "transproc",
    "transvans",
    "transpile",
    "transomed",
    "transires",
    "sumatrans",
    "transition",
    "transplant",
    "transcript",
    "transistor",
    "translator",
    "transgenic",
    "transverse",
    "transitory",
    "transferor",
    "transducer",
    "transferee",
    "transcribe",
    "retransmit",
    "transgress",
    "transitive",
    "transience",
    "transferal",
    "transposon",
    "transpolar",
    "transvalue",
    "transudate",
    "transshape",
    "transships",
    "transsonic",
    "transuding",
    "transports",
    "transposed",
    "transposes",
    "transpired",
    "transpires",
    "transmuted",
    "transmutes",
    "transiency",
    "transgenes",
    "transfused",
    "transfuses",
    "transforms",
    "transfixed",
    "transfixes",
    "transiting",
    "transients",
    "translated",
    "translates",
    "transfects",
    "transected",
    "transeptal",
    "transduced",
    "transduces",
    "transaxles",
    "transcends",
    "transactor",
    "transacted",
    "transputer",
    "translunar",
    "translucid",
    "transfrete",
    "transhuman",
    "transprose",
    "transposal",
    "transprint",
    "transposer",
    "transplace",
    "transmuter",
    "transmeate",
    "transaxial",
    "transexion",
    "transexual",
    "transferer",
    "transwoman",
    "transmural",
    "transolver",
    "transobuoy",
    "transpiler",
    "transpubic",
    "transradar",
    "transigere",
    "transiliac",
    "transgredi",
    "transflash",
    "transitron",
    "transferre",
    "transducin",
    "transdural",
    "transbasal",
    "transacter",
    "fortransit",
    "transunion",
    "transurban",
    "transworld",
    "transtrand",
    "transtario",
    "creditrans",
    "airtransse",
    "alptransit",
    "transacqua",
    "transbrake",
    "transcarga",
    "transcrime",
    "transaction",
    "translation",
    "transparent",
    "transmitter",
    "translucent",
    "transfusion",
    "transformer",
    "transdermal",
    "transceiver",
    "transmittal",
    "transponder",
    "transferase",
    "transferrin",
    "transversal",
    "transalpine",
    "transuranic",
    "transfigure",
    "translocate",
    "translative",
    "transmarine",
    "retranslate",
    "transfinite",
    "transpierce",
    "transpiring",
    "transplants",
    "transported",
    "transporter",
    "transposons",
    "transposing",
    "transmuting",
    "transmitted",
    "transfixing",
    "transfixion",
    "transformed",
    "transfusing",
    "transiently",
    "transhumant",
    "transiences",
    "transhipped",
    "translators",
    "translatory",
    "translating",
    "transitions",
    "transistors",
    "retransform",
    "retransmits",
    "cotransport",
    "transacting",
    "transactors",
    "transcended",
    "transferred",
    "transferrer",
    "transferors",
    "transferees",
    "transfected",
    "transecting",
    "transection",
    "transcripts",
    "transducers",
    "transducing",
    "transcriber",
    "transcribes",
    "transcribed",
    "transvalued",
    "transvalues",
    "transudates",
    "transracial",
    "transgenics",
    "transferral",
    "transdermic",
    "transcalent",
    "transcolate",
    "intransient",
    "transfusive",
    "transforate",
    "transfluent",
    "transilient",
    "transjordan",
    "translunary",
    "transrectal",
    "transportal",
    "transpirate",
    "transmutual",
    "transocular",
    "transnature",
    "transonance",
    "transpadane",
    "transmeable",
    "transsummer",
    "transverter",
    "transmission",
    "transparency",
    "transcendent",
    "transference",
    "transduction",
    "transvestite",
    "transpacific",
    "intransigent",
    "transfection",
    "transoceanic",
    "untranslated",
    "transaminase",
    "intransitive",
    "transmogrify",
    "transhumance",
    "transmigrate",
    "mistranslate",
    "ditransitive",
    "transpontine",
    "transpicuous",
    "transmontane",
    "transductant",
    "transcribing",
    "transcribers",
    "transferases",
    "transferrers",
    "transferring",
    "transfecting",
    "transections",
    "transactions",
    "transceivers",
    "transcending",
    "retranslated",
    "retranslates",
    "transmutable",
    "transmissive",
    "transmittals",
    "transmitters",
    "transmitting",
    "transpierced",
    "transpierces",
    "transplanted",
    "transplanter",
    "transparence",
    "transponders",
    "transporters",
    "transporting",
    "transposable",
    "transhipping",
    "transiencies",
    "transgressed",
    "transgresses",
    "transgressor",
    "transformers",
    "transfusions",
    "transfusible",
    "transfusable",
    "transforming",
    "transferable",
    "transfigured",
    "transfixions",
    "transfigures",
    "transitional",
    "transitively",
    "transitivity",
    "transitorily",
    "translatable",
    "translations",
    "translucence",
    "translocated",
    "translocates",
    "translucency",
    "transvestism",
    "transversals",
    "transversely",
    "transvaluing",
    "transuranium",
    "transshipped",
    "transudation",
    "transluminal",
    "transversion",
    "transgenesis",
    "transmigrant",
    "transmundane",
    "transcurrent",
    "transcursion",
    "transdialect",
    "transcranial",
    "transelement",
    "transcription",
    "transnational",
    "transatlantic",
    "transgression",
    "transgressive",
    "transcriptase",
    "transposition",
    "transmissible",
    "translocation",
    "transmutation",
    "transmembrane",
    "transmittance",
    "transpiration",
    "transpersonal",
    "transthoracic",
    "transliterate",
    "transistorize",
    "transactinide",
    "transactional",
    "transaminases",
    "transcendency",
    "transcendence",
    "transductions",
    "transcultural",
    "transferrable",
    "transfections",
    "intransigence",
    "intransigeant",
    "retranslating",
    "retranslation",
    "retransmitted",
    "mistranslated",
    "mistranslates",
    "intransigents",
    "transistorise",
    "translational",
    "translucences",
    "translocating",
    "translucently",
    "transgressors",
    "transgressing",
    "transfiguring",
    "transformable",
    "transfusional",
    "transparently",
    "transpiercing",
    "transplanters",
    "transplanting",
    "transportable",
    "transmissions",
    "transmittable",
    "transmigrator",
    "transmigrated",
    "transmigrates",
    "transmutative",
    "transudations",
    "transshipping",
    "transshipment",
    "transvestites",
    "transurethral",
    "transcriptome",
    "transactivate",
    "transcatheter",
    "transcaucasia",
    "transcolation",
    "transcriptive",
    "transcribbler",
    "transcurrence",
    "transfeminate",
    "transferrible",
    "transferrence",
    "nontransitive",
    "intransigency",
    "intranscalent",
    "transnatation",
    "transpalatine",
    "transmigrante",
    "transmittancy",
    "transmittible",
    "transportance",
    "transplendent",
    "transportment",
    "transpositive",
    "transportation",
    "transformation",
    "transcendental",
    "transcutaneous",
    "transplacental",
    "untranslatable",
    "transmissivity",
    "transamination",
    "homotransplant",
    "intransigently",
    "intransitively",
    "intransigences",
    "mistranslating",
    "mistranslation",
    "intransitivity",
    "retransmitting",
    "retranslations",
    "retransmission",
    "transcendently",
    "transcendences",
    "transductional",
    "transcriptions",
    "transferential",
    "transmittances",
    "transmogrified",
    "transmogrifies",
    "transmigrating",
    "transmigration",
    "transmigrators",
    "transmigratory",
    "transmutations",
    "transplantable",
    "transpirations",
    "transparencies",
    "transpositions",
    "transformative",
    "transgressions",
    "transliterated",
    "transliterates",
    "translucencies",
    "translocations",
    "transitiveness",
    "transistorizes",
    "transitionally",
    "transitoriness",
    "transistorised",
    "transistorises",
    "transistorized",
    "transvaluation",
    "transshipments",
    "xenotransplant",
    "untransferable",
    "allotransplant",
    "autotransplant",
    "detransitivise",
    "detransitivize",
    "intransigentes",
    "intransitivise",
    "impertransible",
    "subtranslucent",
    "subtransparent",
    "intransitivize",
    "intransmutable",
    "transcorporate",
    "transdniestria",
    "transcapillary",
    "transanimation",
    "transabdominal",
    "transfretation",
    "translatorship",
    "translatitious",
    "transportingly",
    "transplendency",
    "transpatronize",
    "transmittivity",
    "untransmutable",
    "transregionate",
    "transverberate",
    "transvestitism",
    "transsegmental",
    "transsulfurase",
    "transtentorial",
    "transmethylase",
    "transpeptidase",
    "transversourethralis",
    "transdifferentiation",
    "carboxyltransferases",
    "costotransversectomy",
    "carbamoyltransferase",
    "transphosphorylation",
    "diphosphotransferase",
    "pentosyltransferases",
    "autotransplantations",
    "carbamoyltransferases",
    "heterotransplantation",
    "galactosyltransferase",
    "phosphotransacetylase",
    "aminoacyltransferases",
    "nucleotidyltransferase",
    "transphosphoribosidase",
    "nucleotidyltransferases",
    "glucuronosyltransferase",
    "pyrophosphotransferases",
    "transubstantiationalist",
    "transureteroureterostomy",
    "deoxyribosyltransferases",
    "trans-america",
    "gender of nouns",
    "gender of a noun changes"
]


irrelevant_for_anti_keywords = []
ANTI_KEYWORDS = [
    "electric aircraft", "car", "spice girls", "sex slave", "transport",
    "gender of nouns",
    "gender of a noun changes"
    ]
Little_List = KEYWORDS
BIG_LIST = KEYWORDS + OGS_KEYWORDS


import re
def normalize_text(text):
    """
    Normalize text by replacing special characters, removing accents, normalizing Unicode,
    and handling punctuation for robust keyword matching.
    """
    # Replace hyphens, underscores, and newlines with spaces
    text = re.sub(r"[\-_\\n]", " ", text)

    # # Normalize hyphenated words (e.g., "Cass-Report" -> "Cass Report")
    # text = normalize_hyphenated_words(text)

    # # Normalize Unicode characters (e.g., accents)
    # text = normalize_unicode(text)

    # Convert accented characters to their ASCII equivalent
    text = unicodedata.normalize('NFKD', text).encode('ascii', 'ignore').decode('utf-8')

    # Remove punctuation (optional, based on your needs)
    text = re.sub(r'[^\w\s]', '', text)

    # Replace multiple spaces with a single space
    text = re.sub(r'\s+', ' ', text).strip()

    # Convert to lowercase for case-insensitive matching
    return text.lower()

def relative_keywords_score(text: str, bypass_anit=False):
    """
    Calculate the relevance score of a page or anchor text based on keywords and key phrases,
    handling both relevant and irrelevant keywords with context-aware logic and preventing substring conflicts.
    """
    # Normalize text to handle variations like hyphens, underscores, and line breaks
    text = normalize_text(text)

    # Initialize scoring variables
    score = 0
    anti_score = 0
    relevant_window = 50  # Number of characters around a keyword to check for irrelevant content

    # Prepare containers for processing keywords and positions
    found_keywords = []
    found_anti_keywords = []

    # Function to determine if a segment of text contains any irrelevant phrases
    def contains_irrelevant(phrases, segment):
        return any(re.search(r"\b" + re.escape(phrase) + r"\b", segment, re.IGNORECASE) for phrase in phrases)

    # Extract relevant keywords and their positions, using word boundaries to avoid partial matches
    for keyword in KEYWORDS:
        normalized_keyword = normalize_text(keyword)
        for match in re.finditer(r"\b" + re.escape(normalized_keyword) + r"\b", text, re.IGNORECASE):
            start, end = match.start(), match.end()
            # Check for nearby irrelevant content within a defined window
            if not contains_irrelevant(
                irrelevant_for_keywords,
                text[max(0, start - relevant_window): end + relevant_window]
            ):
                found_keywords.append((keyword, start, end))

    # Calculate relevant score based on unique keyword positions
    processed_positions = set()
    for keyword, start, end in found_keywords:
        # Only count keywords that are not overlapping with already processed positions
        if not any(pos in processed_positions for pos in range(start, end)):
            # Assign weights dynamically based on keyword length or type
            keyword_weight = len(keyword.split())  # Longer phrases have more weight
            score += keyword_weight
            processed_positions.update(range(start, end))

    # Extract anti-keywords and their positions
    if not bypass_anit:
        for anti_keyword in ANTI_KEYWORDS:
            normalized_anti_keyword = normalize_text(anti_keyword)
            for match in re.finditer(r"\b" + re.escape(normalized_anti_keyword) + r"\b", text, re.IGNORECASE):
                start, end = match.start(), match.end()
                # Check for nearby relevant content within a defined window
                if not contains_irrelevant(
                    irrelevant_for_keywords,
                    text[max(0, start - relevant_window): end + relevant_window]
                ):
                    found_anti_keywords.append((anti_keyword, start, end))

    # Calculate anti-relevant score based on unique anti-keyword positions
    processed_anti_positions = set()
    for anti_keyword, start, end in found_anti_keywords:
        # Avoid counting anti-keywords that overlap with processed relevant keywords
        if not any(pos in processed_positions for pos in range(start, end)):
            anti_score += 1  # Simple weight for anti-keywords
            processed_anti_positions.update(range(start, end))

    # Calculate the final score and adjust based on the presence of both relevant and irrelevant keywords
    final_score = score - anti_score

    # Return the final score and a list of found relevant keywords for reporting
    return (
        final_score,
        list(set([kw for kw, _, _ in found_keywords])),
        list(set([kw for kw, _, _ in found_anti_keywords]))
    )
